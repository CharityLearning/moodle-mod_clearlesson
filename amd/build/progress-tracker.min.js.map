{"version":3,"file":"progress-tracker.min.js","sources":["../src/progress-tracker.js"],"sourcesContent":["/* eslint-disable promise/catch-or-return */\n// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Progress tracker for mod_clearlesson.\n *\n * @module     mod_clearlesson/progress-tracker\n * @copyright  2024 Dan Watkins <dwatkins@charitylearning.org>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      2.9\n */\n\nimport Ajax from 'core/ajax';\n\nexport const init = async() => {\n    if (typeof window.VimeoPlayerConstructor === 'undefined') {\n        setTimeout(init, 100);\n        return;\n    }\n    if (typeof window.player !== 'undefined') {\n        await window.player.destroy(); // We destroy the previous player before creating a new one.\n        delete window.player;\n    }\n\n    const iframe = document.querySelector('.video-container > iframe.videoframe');\n\n    window.player = new window.VimeoPlayerConstructor(iframe);\n\n    window.extref = await window.player.getVideoTitle().then(function(title) {\n        return title;\n    });\n\n    // When progress is updated, if the video has a higher status already, we don't update it.\n    window.viewedStatus = 'unwatched';\n    window.player.on('play', function() {\n        if (window.viewedStatus === 'unwatched') {\n            window.viewedStatus = 'inprogress';\n        }\n    });\n\n    window.player.on('ended', async function() {\n        if (window.updateProgress) {\n            videoWatched();\n            await updateProgressAndActivity();\n        }\n    });\n\n    window.currentTime = 0;\n    window.player.on('timeupdate', function(data) {\n        window.player.getDuration().then(async function(duration) {\n            // If 90% of the video has been watched, we update the status to 'watched'.\n            if (data.seconds / duration >= 0.9) {\n                if (window.updateProgress) {\n                    videoWatched();\n                    updateProgressAndActivity();\n                }\n            }\n            return true;\n        });\n        // Round off and provide as integer.\n        window.currentTime = Math.round(data.seconds);\n    });\n\n    // Before the user leaves the page, we update the progress.\n    window.addEventListener('beforeunload', async function() {\n        if (window.updateProgress) {\n            await updateProgressAndActivity();\n        }\n    }, true);\n\n    // Every 30 minutes we update the progress.\n    setInterval(async function() {\n        if (window.updateProgress) {\n            await updateProgressAndActivity();\n        }\n    }, 1800000);\n};\n\n/**\n * Update the progress and status of the video.\n *\n * @return {Promise} The promise with the response of the AJAX call.\n */\nconst updateProgress = async() => {\n    if (typeof window.extref === 'undefined'\n        || typeof window.viewedStatus === 'undefined' || typeof window.currentTime === 'undefined'\n        || typeof window.courseid === 'undefined' || typeof window.cmid === 'undefined'\n        || typeof window.resourceRef === 'undefined' || typeof window.type === 'undefined'\n        || typeof window.pageType === 'undefined') {\n        return false;\n    }\n\n    const args = {\n        externalref: window.extref,\n        status: window.viewedStatus,\n        duration: window.currentTime,\n        courseid: window.courseid,\n        cmid: window.cmid,\n        resourceref: window.resourceRef,\n        type: window.type,\n        pagetype: window.pageType\n    };\n\n    const request = {\n                        methodname: 'mod_clearlesson_update_progress',\n                        args: args\n                    };\n\n    return Ajax.call([request])[0];\n};\n\n/**\n * The video has been watched, update the status and reveal any watched checks relevant in the DOM.\n */\nfunction videoWatched() {\n    window.viewedStatus = 'watched';\n    window.updateProgress = false;\n    document.querySelector('.video-title-wrapper .watched-check').classList.remove('notwatched');\n    const playlistVideoLink = document.querySelector('.video-card-side a[data-externalref=\"' + window.extref + '\"]');\n    if (playlistVideoLink) {\n        playlistVideoLink.closest('.video-card-side').querySelector('.watched-check').classList.remove('notwatched');\n        const otherVideosColumn = playlistVideoLink.closest('.box');\n        let watchedAll = true;\n        otherVideosColumn.querySelectorAll('.watched-check').forEach(function(watchedCheck) {\n            if (watchedCheck.classList.contains('notwatched')) {\n                watchedAll = false;\n            }\n        });\n        if (watchedAll) {\n            const itemRef = playlistVideoLink.closest('.incourse-player').getAttribute('data-resourceref');\n            menuItemWatched(itemRef);\n        }\n    }\n}\n\n/**\n * All videos in a menu item have been watched, update the menuitem by removing the notwatched class.\n * @param {String} itemRef The externalref of the menu item.\n * @param {Boolean} direct Is this the direct parent menu?\n * We update the parent menu items by resource ref but sometimes 2 parents\n * eg playlist & series will have the same resource ref. Direct determines which parent to update.\n */\nexport function menuItemWatched(itemRef, direct = true) {\n    var domPosition;\n    const menuItems = document.querySelectorAll('.menu-item[data-externalref=\"' + itemRef + '\"]');\n    if (!menuItems) {\n        return false;\n    }\n    if (direct) {\n        domPosition = menuItems.length - 1;\n    } else {\n        domPosition = 0;\n    }\n    menuItems.forEach(function(singleItem, index) {\n        // The last menu item is the one we want to update as this will be the menuItemParent of the player.\n        if (index === domPosition) {\n            singleItem.querySelector('.watched-check').classList.remove('notwatched');\n            // If all menu items in the parent have been watched, we update the parents parent if it is present.\n            const parentMenu = singleItem.closest('.menu-container');\n            if (parentMenu) {\n                let parentWatchedAll = true;\n                parentMenu.querySelectorAll('.watched-check').forEach(function(watchedCheck) {\n                    if (watchedCheck.classList.contains('notwatched')) {\n                        parentWatchedAll = false;\n                    }\n                });\n                if (parentWatchedAll) {\n                    const parentResourceRef = parentMenu.getAttribute('data-resourceref');\n                    if (direct) { // There will only be ever be 2 parents.\n                        // No infinite loops please.\n                        menuItemWatched(parentResourceRef, false);\n                    }\n                }\n            }\n        }\n    });\n    return true;\n}\n\n/**\n * Update the progress of the video and then the activity module in the course page if required.\n */\nexport async function updateProgressAndActivity() {\n    var activityInfo;\n    const response = await updateProgress();\n    if (response?.activitymodulehtml) {\n        if (window.pageType === 'course') {\n            activityInfo = document.querySelector('.activity[data-id=\"' + window.cmid + '\"]');\n        }\n        if (window.pageType === 'activity') {\n            activityInfo = document.querySelector('.activity-information');\n        }\n        if (activityInfo) {\n            activityInfo.outerHTML = response.activitymodulehtml;\n        }\n    }\n}\n"],"names":["init","async","window","VimeoPlayerConstructor","setTimeout","player","destroy","iframe","document","querySelector","extref","getVideoTitle","then","title","viewedStatus","on","updateProgress","videoWatched","updateProgressAndActivity","currentTime","data","getDuration","duration","seconds","Math","round","addEventListener","setInterval","classList","remove","playlistVideoLink","closest","otherVideosColumn","watchedAll","querySelectorAll","forEach","watchedCheck","contains","menuItemWatched","getAttribute","itemRef","direct","domPosition","menuItems","length","singleItem","index","parentMenu","parentWatchedAll","parentResourceRef","activityInfo","response","courseid","cmid","resourceRef","type","pageType","request","methodname","args","externalref","status","resourceref","pagetype","Ajax","call","activitymodulehtml","outerHTML"],"mappings":";;;;;;;;kPA2BaA,KAAOC,kBAC6B,IAAlCC,OAAOC,mCACdC,WAAWJ,KAAM,UAGQ,IAAlBE,OAAOG,eACRH,OAAOG,OAAOC,iBACbJ,OAAOG,cAGZE,OAASC,SAASC,cAAc,wCAEtCP,OAAOG,OAAS,IAAIH,OAAOC,uBAAuBI,QAElDL,OAAOQ,aAAeR,OAAOG,OAAOM,gBAAgBC,MAAK,SAASC,cACvDA,SAIXX,OAAOY,aAAe,YACtBZ,OAAOG,OAAOU,GAAG,QAAQ,WACO,cAAxBb,OAAOY,eACPZ,OAAOY,aAAe,iBAI9BZ,OAAOG,OAAOU,GAAG,SAASd,iBAClBC,OAAOc,iBACPC,qBACMC,gCAIdhB,OAAOiB,YAAc,EACrBjB,OAAOG,OAAOU,GAAG,cAAc,SAASK,MACpClB,OAAOG,OAAOgB,cAAcT,MAAKX,eAAeqB,iBAExCF,KAAKG,QAAUD,UAAY,IACvBpB,OAAOc,iBACPC,eACAC,8BAGD,KAGXhB,OAAOiB,YAAcK,KAAKC,MAAML,KAAKG,YAIzCrB,OAAOwB,iBAAiB,gBAAgBzB,iBAChCC,OAAOc,sBACDE,+BAEX,GAGHS,aAAY1B,iBACJC,OAAOc,sBACDE,8BAEX,mCAuCED,eACLf,OAAOY,aAAe,UACtBZ,OAAOc,gBAAiB,EACxBR,SAASC,cAAc,uCAAuCmB,UAAUC,OAAO,oBACzEC,kBAAoBtB,SAASC,cAAc,wCAA0CP,OAAOQ,OAAS,SACvGoB,kBAAmB,CACnBA,kBAAkBC,QAAQ,oBAAoBtB,cAAc,kBAAkBmB,UAAUC,OAAO,oBACzFG,kBAAoBF,kBAAkBC,QAAQ,YAChDE,YAAa,KACjBD,kBAAkBE,iBAAiB,kBAAkBC,SAAQ,SAASC,cAC9DA,aAAaR,UAAUS,SAAS,gBAChCJ,YAAa,MAGjBA,WAAY,CAEZK,gBADgBR,kBAAkBC,QAAQ,oBAAoBQ,aAAa,gCAavED,gBAAgBE,aAASC,sEACjCC,kBACEC,UAAYnC,SAAS0B,iBAAiB,gCAAkCM,QAAU,cACnFG,YAIDD,YADAD,OACcE,UAAUC,OAAS,EAEnB,EAElBD,UAAUR,SAAQ,SAASU,WAAYC,UAE/BA,QAAUJ,YAAa,CACvBG,WAAWpC,cAAc,kBAAkBmB,UAAUC,OAAO,oBAEtDkB,WAAaF,WAAWd,QAAQ,sBAClCgB,WAAY,KACRC,kBAAmB,KACvBD,WAAWb,iBAAiB,kBAAkBC,SAAQ,SAASC,cACvDA,aAAaR,UAAUS,SAAS,gBAChCW,kBAAmB,MAGvBA,iBAAkB,OACZC,kBAAoBF,WAAWR,aAAa,oBAC9CE,QAEAH,gBAAgBW,mBAAmB,UAMhD,kBAMW/B,gCACdgC,mBACEC,cArGalD,mBACU,IAAlBC,OAAOQ,aACoB,IAAxBR,OAAOY,mBAA8D,IAAvBZ,OAAOiB,kBACjC,IAApBjB,OAAOkD,eAAmD,IAAhBlD,OAAOmD,WAC1B,IAAvBnD,OAAOoD,kBAAsD,IAAhBpD,OAAOqD,WAChC,IAApBrD,OAAOsD,gBACV,QAcLC,QAAU,CACIC,WAAY,kCACZC,KAbP,CACTC,YAAa1D,OAAOQ,OACpBmD,OAAQ3D,OAAOY,aACfQ,SAAUpB,OAAOiB,YACjBiC,SAAUlD,OAAOkD,SACjBC,KAAMnD,OAAOmD,KACbS,YAAa5D,OAAOoD,YACpBC,KAAMrD,OAAOqD,KACbQ,SAAU7D,OAAOsD,kBAQdQ,cAAKC,KAAK,CAACR,UAAU,IA4ELzC,GACnBmC,MAAAA,UAAAA,SAAUe,qBACc,WAApBhE,OAAOsD,WACPN,aAAe1C,SAASC,cAAc,sBAAwBP,OAAOmD,KAAO,OAExD,aAApBnD,OAAOsD,WACPN,aAAe1C,SAASC,cAAc,0BAEtCyC,eACAA,aAAaiB,UAAYhB,SAASe"}