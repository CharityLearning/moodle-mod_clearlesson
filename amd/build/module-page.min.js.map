{"version":3,"file":"module-page.min.js","sources":["../src/module-page.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A set of functions to be added to charts tab load-tabs.js.\n * Most of these functions enable modal forms for the adding/deleting of charts or editing existing charts.\n *\n * @module     mod_clearlesson/module-page\n * @copyright  2024 Dan Watkins <dwatkins@charitylearning.org>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      2.9\n */\n\nimport * as Utils from './utils';\nimport {get_string as getString} from 'core/str';\nimport Ajax from 'core/ajax';\nimport Templates from 'core/templates';\nimport * as progressTracker from './progress-tracker';\nimport * as pageFunctions from './page-functions';\n\n// eslint-disable-next-line no-unused-vars\nvar url, backString, outputType, playerModalFromMenu, newMenuModal, completionDropdown;\nvar firstLoad = 1;\n\nrequire(['../../../mod/clearlesson/vimeo/vimeo-sdk'], function(VimeoPlayerConstructor) {\n    window.VimeoPlayerConstructor = VimeoPlayerConstructor;\n});\n\nexport const init = async(type) => {\n    window.updateProgress = true;\n    window.pageType = 'activity';\n    var position = 1;\n    backString = await getString('back');\n    url = window.location.href;\n\n    const searchParams = new URLSearchParams(window.location.search);\n    window.cmid = searchParams.get('id');\n    window.courseid = document.getElementById('clearlesson-courseid').getAttribute('data-courseid');\n\n    if (type === 'series' || type === 'collections') {\n        outputType = 'menu';\n    } else {\n        outputType = 'player';\n    }\n\n    const completionInfoElement = document.querySelector('.automatic-completion-conditions');\n    const clearlessonElement = document.querySelector('.mod-clearlesson');\n    if (outputType === 'player') {\n        Utils.waitForElement('.incourse-player', clearlessonElement, async function() {\n            // Store the resource reference and resource type for the progress tracker.\n            // This is only set from the base layer.\n            window.resourceRef = clearlessonElement.querySelector('.incourse-player').getAttribute('data-resourceref');\n            window.type = clearlessonElement.querySelector('.incourse-player').getAttribute('data-type');\n            pageFunctions.updateCompletionStatusIfIncorrect(completionInfoElement, clearlessonElement);\n            pageFunctions.setWindowWatched();\n        });\n    }\n\n    if (outputType === 'menu') {\n        Utils.waitForElement('.incourse-menu', clearlessonElement, async function() {\n            // Store the resource reference for the progress tracker.\n            // This is only set from the base layer.\n            window.resourceRef = clearlessonElement.querySelector('.incourse-menu').getAttribute('data-resourceref');\n            window.type = clearlessonElement.querySelector('.incourse-menu').getAttribute('data-type');\n            pageFunctions.updateCompletionStatusIfIncorrect(completionInfoElement, clearlessonElement);\n            window.updateProgress = false;\n        });\n    }\n\n    document.addEventListener('click', async function(e) {\n        const element = e.target;\n        if (element.classList?.contains('play-icon')\n        || element.parentElement.classList?.contains('play-icon')\n        || element.classList?.contains('video-player-link')\n        || element.parentElement.classList?.contains('video-player-link')) {\n            e.preventDefault();\n            if (element.classList.contains('incourse-player-link')\n            || element.parentElement.classList.contains('incourse-player-link')) {\n                if (element.getAttribute('data-type') === 'playlists'\n                || element.parentElement.getAttribute('data-type') === 'playlists') {\n                    // 2nd level modals.\n                    playerModalFromMenu = await pageFunctions.openPlayerFromMenu(e, url, firstLoad, completionDropdown, backString);\n                } else {\n                    // For collections we'll open the series menu.\n                    newMenuModal = await pageFunctions.openNewMenuModal(e, url, firstLoad, completionDropdown, backString);\n                }\n            } else {\n                position = parseInt(element.closest('.has-position').getAttribute('data-position'));\n                if (element.closest('.modal-body')) {\n                    reRenderModulePlayerModal(position, url);\n                } else {\n                    reRenderPlayer(position);\n                }\n            }\n        }\n    });\n};\n\n/**\n * Rerender the in-page player.\n *\n * @param {Number} position The position of the resource in the list.\n * @param {String} url The URL of the resource.\n */\nasync function reRenderPlayer(position, url) {\n    if (window.updateProgress) {\n        progressTracker.updateProgressAndActivity(); // Record any progress from the last player.\n    }\n    const data = await getPlayerRenderable(position, url);\n    const {html, js} = await Templates.renderForPromise('mod_clearlesson/incourse_player', data.response);\n\n    const pageContainer = document.getElementById('clearlesson-page-container');\n    pageContainer.innerHTML = html;\n\n    await Templates.runTemplateJS(js);\n    progressTracker.init();\n    pageFunctions.setWindowWatched();\n    document.querySelector('.incourse-player').scrollIntoView({behavior: 'smooth'});\n}\n\n/**\n * Get player renderable.\n * @param {Number} position The position of the resource in the list.\n */\nfunction getPlayerRenderable(position) {\n    const request = {\n        methodname: 'mod_clearlesson_get_player_renderable',\n        args: {cmid: window.cmid,\n                course: window.courseid,\n                position: position\n            }\n    };\n\n    return Ajax.call([request])[0];\n}\n\n/**\n * Open the player modal.\n *\n * @param {Number} position The position of the resource in the list.\n * @param {String} url The URL of the resource.\n */\nasync function reRenderModulePlayerModal(position, url) {\n    if (window.updateProgress) {\n        progressTracker.updateProgressAndActivity(); // Record any progress from the last player.\n    }\n    const externalref = document.querySelector('.incourse-player').getAttribute('data-resourceref');\n    const formParams = {cmid: window.cmid,\n                        course: window.courseid,\n                        url: url,\n                        position: position,\n                        firstload: 0,\n                        externalref: externalref};\n    const serialFormParams = Utils.serialize(formParams);\n    const bodyContent = playerModalFromMenu.getBody(serialFormParams);\n    await playerModalFromMenu.modal.setBodyContent(bodyContent);\n    pageFunctions.setWindowWatched();\n    document.querySelector('.incourse-player').scrollIntoView({behavior: 'smooth'});\n}\n\n"],"names":["url","backString","outputType","playerModalFromMenu","require","VimeoPlayerConstructor","window","async","updateProgress","pageType","position","location","href","searchParams","URLSearchParams","search","cmid","get","courseid","document","getElementById","getAttribute","type","completionInfoElement","querySelector","clearlessonElement","Utils","waitForElement","resourceRef","pageFunctions","updateCompletionStatusIfIncorrect","setWindowWatched","addEventListener","e","element","target","classList","contains","parentElement","_element$parentElemen","_element$classList2","_element$parentElemen2","preventDefault","openPlayerFromMenu","completionDropdown","openNewMenuModal","parseInt","closest","progressTracker","updateProgressAndActivity","externalref","formParams","course","firstload","serialFormParams","serialize","bodyContent","getBody","modal","setBodyContent","scrollIntoView","behavior","reRenderModulePlayerModal","data","request","methodname","args","Ajax","call","getPlayerRenderable","html","js","Templates","renderForPromise","response","innerHTML","runTemplateJS","init","reRenderPlayer"],"mappings":"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"}