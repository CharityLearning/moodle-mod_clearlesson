define("mod_clearlesson/modal-resource-browser",["exports","core_form/modalform","core/str","./utils"],(function(_exports,_modalform,_str,Utils){var obj;
/**
   * A set of functions to be added to charts tab load-tabs.js.
   * Most of these functions enable modal forms for the adding/deleting of charts or editing existing charts.
   *
   * @module     mod_clearlesson/modal-resource-browser
   * @copyright  2024 Dan Watkins <dwatkins@charitylearning.org>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   * @since      2.9
   */function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_exports.selectResource=selectResource,_exports.setWaitingCursor=setWaitingCursor,_modalform=(obj=_modalform)&&obj.__esModule?obj:{default:obj},Utils=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(Utils);var modalForm,newResourceSelected=!1,orderedResources=!1,filterValues={animation:"",speakers:"",topics:"",playlists:"",series:"",collections:""};function searchIfSearchbutton(e){var _e$target$classList,_e$target$classList2,_e$target$classList3;(null!==(_e$target$classList=e.target.classList)&&void 0!==_e$target$classList&&_e$target$classList.contains("search-button-parent")||null!==(_e$target$classList2=e.target.classList)&&void 0!==_e$target$classList2&&_e$target$classList2.contains("cl-search-append")||null!==(_e$target$classList3=e.target.classList)&&void 0!==_e$target$classList3&&_e$target$classList3.contains("fa-search"))&&(e.preventDefault(),searchResources(document.getElementById("search").value))}function selectResource(externalref,resourceType){document.getElementById("id_type").value=resourceType,newResourceSelected=externalref;const parent=document.getElementById("id_externalref").parentElement,input=document.querySelector('input[id^="form_autocomplete_input"]');input.value=externalref,input.dispatchEvent(new Event("input",{bubbles:!0}));let suggestions=parent.parentElement.querySelector("ul.form-autocomplete-suggestions");externalref&&Utils.waitForElement('li[data-value="'+externalref+'"]',suggestions.parentElement,(function(){document.querySelector('li[data-value="'+externalref+'"]').click(),document.querySelectorAll(".modal-header button.close").forEach((function(button){button.click()}))}))}function onModalClose(){if(newResourceSelected){const selectedOptionSelector='.form-autocomplete-selection span[role="option"][data-value="'+newResourceSelected+'"]',watch=document.getElementById("id_externalref").parentElement.parentElement;Utils.waitForElement(selectedOptionSelector,watch,(function(){document.querySelector('span[data-fieldtype="autocomplete"').classList.remove("d-none")}))}else document.querySelector('span[data-fieldtype="autocomplete"').classList.remove("d-none")}function getDestinationTypeFromType(type){switch(type){case"speakers":case"topics":case"playlists":return"play";case"series":return"playlists";case"collections":return"series";default:return""}}function setWaitingCursor(waiting,modalObject){let selective=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];var selector;selective?(selector="*:is(.browser-filters *, .modal-content > *, form, form > *, .modal-header *,",selector+=" .modal-footer *, .browser-sidebar, .browser-sidebar *, .resource-container)",selector+=", .video-card-wrapper, .video-card-wrapper *"):selector="*";const modalElement=modalObject.modal.getRoot()[0],resources=[...modalElement.querySelectorAll(selector)];if(waiting)for(const node of resources)node.classList.contains("d-none")||(node.style.cursor="wait");else{modalElement.querySelector(".modal-header > button > span").style.cursor="pointer";for(const node of resources)if(!node.classList.contains("d-none")){let cursor="BUTTON"===node.tagName||"A"===node.tagName||"I"===node.tagName?"pointer":"default";node.style.cursor=cursor}}}function checkDisplayResource(resource,filterName,selectedValue){var _resource$getAttribut;if(""===selectedValue)return!0;const filterValues=null===(_resource$getAttribut=resource.getAttribute("data-"+filterName))||void 0===_resource$getAttribut?void 0:_resource$getAttribut.split(" ");for(let value of filterValues)if(value=value.split("___")[0],value===selectedValue)return!0;return!1}function toggleElement(element,display,filterName){let hiddenByList=element.getAttribute("data-hiddenby");display&&hiddenByList.includes(filterName)&&(hiddenByList=hiddenByList.replace(filterName,""),hiddenByList=hiddenByList.trim(),element.setAttribute("data-hiddenby",hiddenByList),""===hiddenByList&&(element.classList.remove("d-none"),element.setAttribute("aria-hidden","false"))),display||""!==hiddenByList&&hiddenByList.includes(filterName)||(hiddenByList+=" "+filterName,element.setAttribute("data-hiddenby",hiddenByList.trim()),element.classList.add("d-none"),element.setAttribute("aria-hidden","true"))}function searchResources(query){const lowerQuery=query.trim().toLowerCase(),resources=modalForm.modal.getRoot()[0].getElementsByClassName("video-card-wrapper");for(const resource of resources){const searchables=resource.getElementsByClassName("searchable");var display=!1;if(""===lowerQuery)display=!0;else for(const searchItem of searchables)if(display=searchItem.textContent.toLowerCase().includes(lowerQuery))break;toggleElement(resource,display,"search")}return!0}function scrollToTop(){document.getElementsByClassName("browser-filters")[0].scrollIntoView({behavior:"smooth",block:"end"})}_exports.init=()=>{document.addEventListener("click",(function(e){var _element$classList,_element$classList2;const element=e.target;if("resource-select-button"===element.getAttribute("id")&&(e.preventDefault(),async function(){const resourceType=document.getElementById("id_type").value,cmid=document.querySelector('input[name="coursemodule"]').value,courseid=document.querySelector('input[name="course"]').value,url=window.location.href;var lazyLoad=!1;"video"===resourceType&&(lazyLoad=!0);const browserForm=await new _modalform.default({formClass:"mod_clearlesson\\forms\\resource_browser_form",args:{type:resourceType,cmid:cmid,course:courseid,url:url,lazyload:lazyLoad},modalConfig:{title:(0,_str.get_string)("resourcebrowser","mod_clearlesson")}});modalForm=browserForm,browserForm.addEventListener(browserForm.events.LOADED,(function(){let modalHeight=Math.ceil(.94*window.innerHeight),modalWidth=Math.ceil(.94*window.innerWidth);modalWidth=modalWidth>1800?1800:modalWidth;const modalRootInner=browserForm.modal.getRoot()[0].children[0];modalRootInner.setAttribute("style","width: "+modalWidth+"px;max-width: "+modalWidth+"px;height: "+modalHeight+"px;max-height: "+modalHeight+"px;"),newResourceSelected=!1,setTimeout((function(){document.querySelector('span[data-fieldtype="autocomplete"').classList.add("d-none")}),100),modalRootInner.addEventListener("click",(function(e){if(e.target.classList.contains("type-button")){e.preventDefault();!async function(type,cmid,courseid,url,browserForm){let externalref=arguments.length>5&&void 0!==arguments[5]?arguments[5]:"";var lazyLoad=!1;"play"===type&&(lazyLoad=!0);var formParams={type:type,cmid:cmid,course:courseid,url:url,lazyload:lazyLoad};externalref&&(formParams.destinationtype=getDestinationTypeFromType(type),formParams.filtervalue=externalref);setWaitingCursor(!0,modalForm);const serialFormParams=Utils.serialize(formParams),bodyContent=browserForm.getBody(serialFormParams);await browserForm.modal.setBodyContent(bodyContent),setWaitingCursor(!1,modalForm),scrollToTop(),filterValues={animation:"",speakers:"",topics:"",playlists:"",series:"",collections:""}}(e.target.getAttribute("data-type"),cmid,courseid,url,browserForm)}})),Utils.waitForElement(".modal-footer button.btn-primary",modalRootInner,(function(){modalRootInner.querySelector(".modal-footer button.btn-primary").classList.add("d-none")}))})),browserForm.show()}()),null!==(_element$classList=element.classList)&&void 0!==_element$classList&&_element$classList.contains("select-resource-button")){e.preventDefault();selectResource(element.getAttribute("data-externalref"),e.target.getAttribute("data-type"))}(null!==(_element$classList2=element.classList)&&void 0!==_element$classList2&&_element$classList2.contains("close")||"cancel"===element.getAttribute("data-action")||"hide"===element.getAttribute("data-action")||"hide"===element.parentElement.getAttribute("data-action"))&&onModalClose(),searchIfSearchbutton(e),element.closest('.form-autocomplete-suggestions li[role="option"]')&&document.getElementById("fgroup_id_error_ref_select_group").removeAttribute("style")})),document.addEventListener("keydown",(function(e){"Escape"===e.key&&onModalClose()})),document.addEventListener("change",(async function(e){var _e$target,_e$target2;if("id_type"===(null===(_e$target=e.target)||void 0===_e$target?void 0:_e$target.getAttribute("id"))&&function(){const selectedoption=document.getElementById("id_externalref").parentElement.querySelector('span[role="option"]');null==selectedoption||selectedoption.firstElementChild.click()}(),null!==(_e$target2=e.target)&&void 0!==_e$target2&&_e$target2.classList.contains("browser-filter")){const filterName=e.target.getAttribute("name"),seletedValue=e.target.value;orderedResources&&await async function(){return new Promise((resolve=>{modalForm.modal.getRoot()[0].querySelectorAll(".video-card-wrapper:not(.d-none)").forEach((function(resource){resource.style.order=""})),orderedResources=!1,resolve()}))}(),await async function(filterName,selectedValue){return new Promise((resolve=>{filterValues[filterName]!==selectedValue&&(setWaitingCursor(!0,modalForm),setTimeout((function(){const resources=modalForm.modal.getRoot()[0].getElementsByClassName("video-card-wrapper");for(const resource of resources){toggleElement(resource,checkDisplayResource(resource,filterName,selectedValue),filterName)}setWaitingCursor(!1,modalForm),filterValues[filterName]=selectedValue,resolve()}),100))}))}(filterName,seletedValue),"playlists"!==filterName&&"series"!==filterName||function(type,selectedValue){let positionArray=[];modalForm.modal.getRoot()[0].querySelectorAll(".video-card-wrapper:not(.d-none)").forEach((function(resource){const list=resource.getAttribute("data-"+type);if(list)for(let listItem of list.split(" "))if(listItem.trim()&&listItem.includes(selectedValue)){const order=listItem.split("___")[1];positionArray.push({order:order,resource:resource})}}));for(let i=0;i<positionArray.length;i++)positionArray[i].resource.style.order=positionArray[i].order;orderedResources=!0}(filterName,seletedValue)}})),document.addEventListener("keydown",(function(e){var _e$target3;"Enter"!==e.key&&"Return"!==e.key||("search"===(null===(_e$target3=e.target)||void 0===_e$target3?void 0:_e$target3.getAttribute("id"))&&(e.preventDefault(),searchResources(e.target.value)),searchIfSearchbutton(e))})),Utils.waitForElement(".form-autocomplete-selection",document,(function(){document.getElementById("id_type").removeAttribute("disabled"),document.getElementById("resource-select-button").removeAttribute("disabled")}))}}));

//# sourceMappingURL=modal-resource-browser.min.js.map