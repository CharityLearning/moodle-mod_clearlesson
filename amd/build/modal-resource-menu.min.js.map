{"version":3,"file":"modal-resource-menu.min.js","sources":["../src/modal-resource-menu.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A set of functions to be added to charts tab load-tabs.js.\n * Most of these functions enable modal forms for the adding/deleting of charts or editing existing charts.\n *\n * @module     mod_clearlesson/modal-resource-menu\n * @copyright  2024 Dan Watkins <dwatkins@charitylearning.org>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      2.9\n */\n\nimport ModalForm from 'core_form/modalform';\nimport {get_string as getString} from 'core/str';\nimport * as Utils from './utils';\n\nvar currentMenuForm, backString;\nexport const init = async() => {\n    backString = await getString('back');\n    document.addEventListener('click', function(e) {\n        var element = e.target;\n        var speakerLink = false;\n        var externalref;\n        // This is the eye icon on non-video resources in the resource menu.\n        if (element.classList?.contains('view-icon')\n        || element.classList?.contains('view-link')) {\n            externalref = element.getAttribute('data-externalref');\n        }\n        // This is also the eye icon on non-video resources in the resource menu.\n        if (element.parentElement.classList?.contains('view-icon')\n        || element.parentElement.classList?.contains('view-link')) {\n            externalref = element.parentElement.getAttribute('data-externalref');\n        }\n\n        // This is the {{count}} videos or playlists etc link in the resource browser.\n        if ((element.classList?.contains('video-details-view'))\n        && !element.classList?.contains('view-link')) {\n            if (element.hasAttribute('data-view')) {\n                externalref = element.getAttribute('data-view');\n            } else {\n                externalref = element.parentElement.getAttribute('data-view');\n            }\n        }\n\n        // This is the speaker link in the video card.\n        if (element.classList?.contains('vid-speaker-link')) {\n            externalref = element.closest('.video-card-wrapper').getAttribute('data-speakers');\n            speakerLink = true;\n        }\n\n        if (externalref) {\n            e.preventDefault();\n            if (element.classList.contains('view-link')\n                || element.parentElement.classList.contains('view-link')) {\n                const type = document.querySelector('.menu-container').getAttribute('data-itemtype');\n                const card = element.closest('.menu-item-card');\n                const name = card.querySelector('.card-title').innerText.trim();\n                reRenderResourceMenu(externalref, name, type);\n            } else {\n                const card = element.closest('.video-card-wrapper');\n                var name;\n                if (speakerLink) {\n                    name = element.innerText;\n                } else {\n                    name = card.querySelector('.card-title').innerText;\n                }\n                openResourceMenu(externalref, name, speakerLink);\n            }\n        }\n    });\n};\n\n/**\n * Open the resource menu modal.\n *\n * @param {String} externalref\n * @param {String} name\n * @param {Boolean} speaker\n */\nasync function openResourceMenu(externalref, name, speaker = false) {\n    var resourceType;\n    if (speaker) {\n        resourceType = 'speakers';\n    } else {\n        resourceType = document.getElementsByClassName('disabled-looking')[0].getAttribute('data-type');\n    }\n    const cmid = document.querySelector('input[name=\"coursemodule\"]').value;\n    const courseid = document.querySelector('input[name=\"course\"]').value;\n    const url = window.location.href;\n    const {titleString, selectString} = await getStringsFromResourceType(resourceType, name);\n\n    const menuForm = new ModalForm({\n        formClass: 'mod_clearlesson\\\\forms\\\\resource_menu_form',\n        args: {type: resourceType, cmid: cmid, course: courseid, url: url, externalref: externalref},\n        modalConfig: {title: titleString, saveButtonText: selectString},\n    });\n\n    currentMenuForm = menuForm;\n\n    menuForm.addEventListener(menuForm.events.LOADED, async function() {\n        setButtons(await selectString, resourceType, externalref, backString);\n    });\n\n    menuForm.show();\n}\n\n/**\n * Re-render the resource menu modal.\n *\n * @param {String} externalref\n * @param {String} name\n * @param {String} type\n */\nasync function reRenderResourceMenu(externalref, name, type) {\n    const {titleString, selectString} = await getStringsFromResourceType(type, name);\n    const cmid = document.querySelector('input[name=\"coursemodule\"]').value;\n    const courseid = document.querySelector('input[name=\"course\"]').value;\n    const url = window.location.href;\n    const formParams = {type: type, cmid: cmid, course: courseid, url: url, externalref: externalref};\n    const serialFormParams = Utils.serialize(formParams);\n    const bodyContent = currentMenuForm.getBody(serialFormParams);\n    // Set the title\n    await currentMenuForm.modal.setTitle(titleString);\n    await currentMenuForm.modal.setBodyContent(bodyContent);\n    setButtons(await selectString, type, externalref, backString);\n}\n\n/**\n * Get the title and select strings for the resource menu modal.\n *\n * @param {String} resourceType\n * @param {String} name\n */\nasync function getStringsFromResourceType(resourceType, name) {\n    var titleString, selectString;\n    switch (resourceType) {\n        case 'playlists':\n            titleString = await getString('playlistmenu', 'mod_clearlesson');\n            titleString = \"'\" + name + \"' \" + titleString;\n            selectString = getString('selectplaylist', 'mod_clearlesson');\n            break;\n        case 'speakers':\n            titleString = await getString('videos', 'mod_clearlesson');\n            titleString = name + \"'s \" + titleString;\n            selectString = getString('selectspeaker', 'mod_clearlesson');\n            break;\n        case 'topics':\n            titleString = await getString('videos', 'mod_clearlesson');\n            titleString = \"'\" + name + \"' \" + titleString;\n            selectString = getString('selecttopic', 'mod_clearlesson');\n            break;\n        case 'series':\n            titleString = await getString('seriesmenu', 'mod_clearlesson');\n            titleString = \"'\" + name + \"' \" + titleString;\n            selectString = getString('selectseries', 'mod_clearlesson');\n            break;\n        case 'collections':\n            titleString = await getString('collectionmenu', 'mod_clearlesson');\n            titleString = \"'\" + name + \"' \" + titleString;\n            selectString = getString('selectcollection', 'mod_clearlesson');\n            break;\n    }\n    return {titleString, selectString};\n}\n\n/**\n * Set the save button for the resource menu modal.\n * @param {String} saveString\n * @param {String} type\n * @param {String} externalref\n * @param {String} backString\n */\nasync function setButtons(saveString, type, externalref, backString) {\n    const modalRootInner = currentMenuForm.modal.getRoot()[0].children[0];\n    Utils.waitForElement('.modal-footer button.btn-primary', modalRootInner, function() {\n        const saveButton = modalRootInner.querySelector('.modal-footer button.btn-primary');\n        saveButton.innerHTML = saveString;\n        saveButton.setAttribute('data-action', 'select');\n        saveButton.setAttribute('data-type', type);\n        saveButton.setAttribute('data-externalref', externalref);\n        saveButton.classList.add('select-resource-button');\n        saveButton.classList.add('d-block');\n        const cancelButton = modalRootInner.querySelector('.modal-footer button.btn-secondary');\n        cancelButton.innerHTML = backString;\n    });\n}\n"],"names":["currentMenuForm","backString","getStringsFromResourceType","resourceType","name","titleString","selectString","setButtons","saveString","type","externalref","modalRootInner","modal","getRoot","children","Utils","waitForElement","saveButton","querySelector","innerHTML","setAttribute","classList","add","async","document","addEventListener","e","element","target","speakerLink","contains","_element$classList2","getAttribute","parentElement","_element$parentElemen2","_element$classList3","_element$classList4","hasAttribute","_element$classList5","closest","preventDefault","cmid","value","courseid","url","window","location","href","formParams","course","serialFormParams","serialize","bodyContent","getBody","setTitle","setBodyContent","reRenderResourceMenu","innerText","trim","card","getElementsByClassName","menuForm","ModalForm","formClass","args","modalConfig","title","saveButtonText","events","LOADED","show","openResourceMenu"],"mappings":"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"}