define("mod_clearlesson/progress-tracker",["exports","core/ajax"],(function(_exports,_ajax){var obj;
/**
   * Progress tracker for mod_clearlesson.
   *
   * @module     mod_clearlesson/progress-tracker
   * @copyright  2024 Dan Watkins <dwatkins@charitylearning.org>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   * @since      2.9
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_exports.menuItemWatched=menuItemWatched,_exports.updateProgressAndActivity=updateProgressAndActivity,_ajax=(obj=_ajax)&&obj.__esModule?obj:{default:obj};var loopCount=0;const init=async()=>{var _container$querySelec;if(void 0===window.VimeoPlayerConstructor)return void setTimeout(init,100);void 0!==window.player&&(await window.player.destroy(),delete window.player);const iframe=document.querySelector(".video-container > iframe.videoframe");window.player=new window.VimeoPlayerConstructor(iframe),window.extref=await window.player.getVideoTitle().then((function(title){return title}));const container=iframe.closest(".incourse");"1"==(null==container?void 0:container.getAttribute("data-watchedall"))?(window.watchedAll=!0,window.updateProgress=!1):(window.watchedAll=!1,window.updateProgress=!0),window.viewedStatus=null!=container&&null!==(_container$querySelec=container.querySelector(".video-title-wrapper .watched-check"))&&void 0!==_container$querySelec&&_container$querySelec.classList.contains("notwatched")?"unwatched":"watched",window.player.on("play",(function(){"unwatched"===window.viewedStatus&&(window.viewedStatus="inprogress")})),window.player.on("ended",(async function(){window.updateProgress&&(videoWatched(),updateProgressAndActivity())})),window.currentTime=0,window.player.on("timeupdate",(function(data){window.player.getDuration().then((async function(duration){return data.seconds/duration>=.9&&window.updateProgress&&(videoWatched(),updateProgressAndActivity()),!0})),window.currentTime=Math.round(data.seconds)})),window.addEventListener("beforeunload",(async function(){window.updateProgress&&updateProgressAndActivity()}),!0),setInterval((async function(){window.updateProgress&&updateProgressAndActivity()}),18e5)};_exports.init=init;function videoWatched(){window.viewedStatus="watched",window.updateProgress=!1,document.querySelector(".video-title-wrapper .watched-check").classList.remove("notwatched");const playlistVideoLink=document.querySelector('.video-card-side a[data-externalref="'+window.extref+'"]');if(playlistVideoLink){playlistVideoLink.closest(".video-card-side").querySelector(".watched-check").classList.remove("notwatched");const otherVideosColumn=playlistVideoLink.closest(".box");let watchedAll=!0;if(otherVideosColumn.querySelectorAll(".watched-check").forEach((function(watchedCheck){watchedCheck.classList.contains("notwatched")&&(watchedAll=!1)})),watchedAll){menuItemWatched(playlistVideoLink.closest(".incourse-player").getAttribute("data-resourceref"))}}}function menuItemWatched(itemRef){let direct=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];var domPosition;const menuItems=document.querySelectorAll('.menu-item[data-externalref="'+itemRef+'"]');return!!menuItems&&(domPosition=direct?menuItems.length-1:0,menuItems.forEach((function(singleItem,index){if(index===domPosition){singleItem.querySelector(".watched-check").classList.remove("notwatched");const parentMenu=singleItem.closest(".menu-container");if(parentMenu){let watchedAll=!0;if(parentMenu.querySelectorAll(".watched-check").forEach((function(watchedCheck){watchedCheck.classList.contains("notwatched")&&(watchedAll=!1)})),watchedAll){const parentResourceRef=parentMenu.getAttribute("data-resourceref");direct&&menuItemWatched(parentResourceRef,!1)}}}})),!0)}async function updateProgressAndActivity(){var activityInfo;const response=await(async()=>{if(void 0!==window.viewedStatus||"series"!==window.type&&"collections"!==window.type||(window.viewedStatus=window.watchedAll?"watched":"unwatched"),void 0===window.extref||void 0===window.currentTime||void 0===window.viewedStatus||void 0===window.courseid||void 0===window.cmid||void 0===window.resourceRef||void 0===window.type||void 0===window.pageType||void 0===window.watchedAll)return!1;loopCount=0;const request={methodname:"mod_clearlesson_update_progress",args:{externalref:window.extref,status:window.viewedStatus,duration:window.currentTime,courseid:window.courseid,cmid:window.cmid,resourceref:window.resourceRef,type:window.type,pagetype:window.pageType,watchedall:window.watchedAll}};return _ajax.default.call([request])[0]})();if(!response&&loopCount++<20)return setTimeout(updateProgressAndActivity,100),!1;var _document$querySelect;null!=response&&response.activitymodulehtml&&("course"===window.pageType&&(activityInfo=document.querySelector('.activity[data-id="'+window.cmid+'"]')),"activity"===window.pageType&&(activityInfo=document.querySelector(".activity-information")),activityInfo&&(activityInfo.outerHTML=response.activitymodulehtml),window.watchedAll=!0,null===(_document$querySelect=document.querySelector(".incourse"))||void 0===_document$querySelect||_document$querySelect.setAttribute("data-watchedall","1"));return!0}}));

//# sourceMappingURL=progress-tracker.min.js.map