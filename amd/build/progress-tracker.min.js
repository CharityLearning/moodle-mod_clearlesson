define("mod_clearlesson/progress-tracker",["exports","core/ajax"],(function(_exports,_ajax){var obj;
/**
   * Progress tracker for mod_clearlesson.
   *
   * @module     mod_clearlesson/progress-tracker
   * @copyright  2024 Dan Watkins <dwatkins@charitylearning.org>
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   * @since      2.9
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_exports.updateProgressAndActivity=updateProgressAndActivity,_ajax=(obj=_ajax)&&obj.__esModule?obj:{default:obj};_exports.init=async()=>{void 0!==window.player&&(await window.player.destroy(),delete window.player);const iframe=document.querySelector(".video-container > iframe.videoframe");window.player=new window.VimeoPlayerConstructor(iframe),window.extref=await window.player.getVideoTitle().then((function(title){return title})),window.viewedStatus="unwatched",window.player.on("play",(function(){"unwatched"===window.viewedStatus&&(window.viewedStatus="inprogress")})),window.player.on("ended",(async function(){window.watched||(videoWatched(),await updateProgressAndActivity())})),window.currentTime=0,window.player.on("timeupdate",(function(data){window.player.getDuration().then((async function(duration){return data.seconds/duration>=.9&&(window.watched||(videoWatched(),updateProgressAndActivity())),!0})),window.currentTime=Math.round(data.seconds)})),window.addEventListener("beforeunload",(async function(){window.watched||await updateProgressAndActivity()}),!0),setInterval((async function(){window.watched||await updateProgressAndActivity()}),18e5)};function videoWatched(){window.viewedStatus="watched",window.watched=!0,document.querySelector(".video-title-wrapper .watched-check").classList.remove("notwatched");const playlistVideoLink=document.querySelector('.video-card-side a[data-externalref="'+window.extref+'"]');playlistVideoLink&&playlistVideoLink.closest(".video-card-side").querySelector(".watched-check").classList.remove("notwatched")}async function updateProgressAndActivity(){const response=await(async()=>{if(void 0===window.extref||void 0===window.viewedStatus||void 0===window.currentTime||void 0===window.courseid||void 0===window.cmid||void 0===window.resourceRef||void 0===window.type)return!1;const request={methodname:"mod_clearlesson_update_progress",args:{externalref:window.extref,status:window.viewedStatus,duration:window.currentTime,courseid:window.courseid,cmid:window.cmid,resourceref:window.resourceRef,type:window.type}};return _ajax.default.call([request])[0]})();if(null!=response&&response.activitymodulehtml){const activity=document.querySelector('.activity[data-id="'+window.cmid+'"]');activity&&(activity.outerHTML=response.activitymodulehtml)}}}));

//# sourceMappingURL=progress-tracker.min.js.map