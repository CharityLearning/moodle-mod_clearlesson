{"version":3,"file":"course-page.min.js","sources":["../src/course-page.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * A set of functions to be added to charts tab load-tabs.js.\n * Most of these functions enable modal forms for the adding/deleting of charts or editing existing charts.\n *\n * @module     mod_clearlesson/course-page\n * @copyright  2024 Dan Watkins <dwatkins@charitylearning.org>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n * @since      2.9\n */\n\nimport ModalForm from 'core_form/modalform';\nimport * as Utils from './utils';\nimport * as progressTracker from './progress-tracker';\nimport Ajax from 'core/ajax';\nimport {get_string as getString} from 'core/str';\nimport * as pageFunctions from './page-functions';\n\nvar url, playerModal, formClass, backString, modalType, playerModalFromMenu, completionInfoElement;\nvar firstLoad = 1;\n\nexport const init = () => {\n    var position = 1;\n    window.buttonClicktimeOut = false;\n    window.pageType = 'course';\n    window.openPlayer = async(e, type) => {\n        // Window.buttonClicktimeOut is set to true and checked in the course page link onclick.\n        modalDoubleClickTimeout();\n        if (e.target.href.includes('clearlesson')) {\n            e.preventDefault();\n            backString = await getString('back');\n            const elementAncestor = e.target.closest('.activity');\n            completionInfoElement = elementAncestor.querySelector('.completion-dropdown button');\n            // Used in the progress tracker as well as on this page.\n            window.cmid = elementAncestor.querySelector('.activityname a')\n                                                .getAttribute('href').split('id=')[1];\n\n            const searchParams = new URLSearchParams(window.location.search);\n            url = e.target.href;\n            window.courseid = searchParams.get('id'); // Used in the progress tracker as well as on this page.\n            const instanceNameElement = elementAncestor.querySelector('.activityname .instancename');\n            const span = instanceNameElement.querySelector('span');\n            if (span) {\n                instanceNameElement.removeChild(span);\n            }\n            const instanceName = instanceNameElement.innerText;\n\n            if (type === 'series' || type === 'collections') {\n                formClass = 'mod_clearlesson\\\\forms\\\\incourse_menu_form';\n                modalType = 'menu';\n            } else {\n                formClass = 'mod_clearlesson\\\\forms\\\\incourse_player_form';\n                modalType = 'player';\n            }\n\n            if (window.updateProgress) {\n                await progressTracker.updateProgressAndActivity(); // Record any progress from the last player.\n            }\n\n            playerModal = new ModalForm({\n                formClass: formClass,\n                args: {cmid: window.cmid,\n                        course: window.courseid,\n                        url: url,\n                        firstload: firstLoad},\n                modalConfig: {title: instanceName},\n            });\n\n            playerModal.addEventListener(playerModal.events.LOADED, function() {\n                const modalRootInner = playerModal.modal.getRoot()[0].children[0];\n                // Store the resource reference for the progress tracker.\n                pageFunctions.setModalButtons(modalRootInner, backString);\n                pageFunctions.setModalBodyGrey(modalRootInner);\n\n                // Fullscreen modal for series, topics and playlists.\n                if (type !== 'play' && modalType === 'player') {\n                    pageFunctions.setModalFullscreen(modalRootInner);\n                }\n\n                if (modalType === 'player') {\n                    Utils.waitForElement('.incourse-player', modalRootInner, async function() {\n                        // Store the resource reference and resource type for the progress tracker.\n                        // These are only set from the base layer.\n                        window.resourceRef = modalRootInner.querySelector('.incourse-player').getAttribute('data-resourceref');\n                        pageFunctions.updateCompletionStatusIfIncorrect(completionInfoElement, modalRootInner);\n                        window.type = document.querySelector('.incourse-player').getAttribute('data-type');\n                        pageFunctions.setWindowWatched();\n                        firstLoad = 0;\n                    });\n                }\n\n                if (modalType === 'menu') {\n                    Utils.waitForElement('.incourse-menu', modalRootInner, async function() {\n                        // Store the resource reference and resource type for the progress tracker.\n                        // These are only set from the base layer.\n                        window.resourceRef = modalRootInner.querySelector('.incourse-menu').getAttribute('data-resourceref');\n                        window.type = document.querySelector('.incourse-menu').getAttribute('data-type');\n                        pageFunctions.updateCompletionStatusIfIncorrect(completionInfoElement, modalRootInner);\n                        window.updateProgress = false;\n                    });\n                }\n\n                Ajax.call([{\n                    methodname: 'mod_clearlesson_course_module_viewed',\n                    args: {courseid: window.courseid, cmid: window.cmid},\n                    done: function(response) {\n                        // Update the entire activity module html, this update the completion status if present.\n                        e.target.closest('.activity').outerHTML = response.activitymodulehtml;\n                    }\n                }]);\n            });\n\n            playerModal.show();\n        }\n    };\n\n    document.addEventListener('click', async function(e) {\n        const element = e.target;\n        if (element.classList?.contains('play-icon')\n        || element.parentElement.classList?.contains('play-icon')\n        || element.classList?.contains('video-player-link')\n        || element.parentElement.classList?.contains('video-player-link')) {\n            e.preventDefault();\n            if (element.classList.contains('incourse-player-link')\n            || element.parentElement.classList.contains('incourse-player-link')) {\n                if (element.getAttribute('data-type') === 'playlists'\n                || element.parentElement.getAttribute('data-type') === 'playlists') {\n                    // 2nd level modals.\n                    playerModalFromMenu = await pageFunctions.openPlayerFromMenu(e,\n                                                                                url,\n                                                                                firstLoad,\n                                                                                completionInfoElement,\n                                                                                backString);\n                } else {\n                    // For collections we'll open the series menu.\n                    await pageFunctions.openNewMenuModal(e, url, firstLoad, completionInfoElement);\n                }\n            } else {\n                position = parseInt(element.closest('.has-position').getAttribute('data-position'));\n                reRenderCoursePlayerModal(position, url);\n            }\n        }\n    });\n};\n\n/**\n * Open the player modal.\n *\n * @param {Number} position The position of the resource in the list.\n * @param {String} url The URL of the resource.\n */\nasync function reRenderCoursePlayerModal(position, url) {\n    var theModal;\n    const formParams = {cmid: window.cmid, course: window.courseid, url: url, position: position, firstload: 0};\n    if (modalType === 'player') {\n        theModal = playerModal;\n    }\n    if (modalType === 'menu') {\n        theModal = playerModalFromMenu;\n        formParams.externalref = document.querySelector('.incourse-player').getAttribute('data-resourceref');\n    }\n    const serialFormParams = Utils.serialize(formParams);\n    if (window.updateProgress) {\n        await progressTracker.updateProgressAndActivity(); // Record any progress from the last player.\n    }\n    const bodyContent = theModal.getBody(serialFormParams);\n    await theModal.modal.setBodyContent(bodyContent);\n    pageFunctions.setWindowWatched();\n}\n\n/**\n * Prevent double clicks opening duplicate modals.\n */\nfunction modalDoubleClickTimeout() {\n    setTimeout(function() {\n        window.buttonClicktimeOut = false;\n    }, 600);\n}"],"names":["url","playerModal","formClass","backString","modalType","playerModalFromMenu","completionInfoElement","firstLoad","window","buttonClicktimeOut","pageType","openPlayer","async","e","type","setTimeout","target","href","includes","preventDefault","elementAncestor","closest","querySelector","cmid","getAttribute","split","searchParams","URLSearchParams","location","search","courseid","get","instanceNameElement","span","removeChild","instanceName","innerText","updateProgress","progressTracker","updateProgressAndActivity","ModalForm","args","course","firstload","modalConfig","title","addEventListener","events","LOADED","modalRootInner","modal","getRoot","children","pageFunctions","setModalButtons","setModalBodyGrey","setModalFullscreen","Utils","waitForElement","resourceRef","updateCompletionStatusIfIncorrect","document","setWindowWatched","call","methodname","done","response","outerHTML","activitymodulehtml","show","element","classList","contains","parentElement","_element$parentElemen","_element$classList2","_element$parentElemen2","openPlayerFromMenu","openNewMenuModal","position","theModal","formParams","externalref","serialFormParams","serialize","bodyContent","getBody","setBodyContent","reRenderCoursePlayerModal","parseInt"],"mappings":"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"}